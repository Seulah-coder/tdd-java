# åŒæ™‚å®Ÿè¡Œæ€§ç«¶åˆï¼ˆRace Conditionï¼‰ã«é–¢ã™ã‚‹å ±å‘Šæ›¸

## 1ï¸âƒ£ åŒæ™‚å®Ÿè¡Œæ€§ç«¶åˆãŒç™ºç”Ÿã™ã‚‹ç†ç”±

åŒæ™‚å®Ÿè¡Œæ€§ç«¶åˆï¼ˆRace Conditionï¼‰ã¨ã¯ã€è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã«åŒæ™‚ã«èª­ã¿æ›¸ãã™ã‚‹ã“ã¨ã§ã€äºˆæœŸã›ã¬çµæœãŒç”Ÿã˜ã‚‹çŠ¶æ³ã‚’æŒ‡ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ãƒã‚¤ãƒ³ãƒˆãƒãƒ£ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã«ãŠã„ã¦ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```java
long current = userPointTable.selectById(userId).point(); // â‘ èª­ã¿å–ã‚Š
long updated = current + amount;                          // â‘¡è¨ˆç®—
userPointTable.insertOrUpdate(userId, updated);           // â‘¢æ›¸ãè¾¼ã¿

```

åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒæ™‚ã«ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹å ´åˆã€è¡çªãŒç™ºç”Ÿã—ã¾ã™ã€‚

- ä¸¡æ–¹ã¨ã‚‚â‘ èª­ã¿å–ã‚Šã§ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆãŒ500ã¨å–å¾—
- ã‚¹ãƒ¬ãƒƒãƒ‰Aã¯100ã‚’åŠ ç®—ã—ã¦600ã‚’è¨ˆç®—ã€ã‚¹ãƒ¬ãƒƒãƒ‰Bã‚‚åŒã˜ã600ã‚’è¨ˆç®—
- ã‚¹ãƒ¬ãƒƒãƒ‰AãŒå…ˆã«DB/ãƒ¡ãƒ¢ãƒªã«ä¿å­˜ â†’ 600
- ã‚¹ãƒ¬ãƒƒãƒ‰BãŒãã®å¾Œã«ä¿å­˜ â†’ 600

| ã‚¹ãƒ¬ãƒƒãƒ‰ | èª­ã¿å–ã‚Š(current) | è¨ˆç®—(updated) | æ›¸ãè¾¼ã¿(DBåæ˜ ) |
| --- | --- | --- | --- |
| Thread A | 500 | 500 + 100 = 600 | 600 |
| Thread B | 500 | 500 + 100 = 600 | 600 |

âœ… çµæœ: æœ¬æ¥ 500 + 100 + 100 = 700 ã®ã¯ãšãŒã€æœ€çµ‚DBå€¤ã¯ **600** â†’ åŒæ™‚æ€§è¡çªç™ºç”Ÿ

---

## 2ï¸âƒ£ ç«¶åˆãŒç™ºç”Ÿã™ã‚‹å…¸å‹çš„ãªã‚±ãƒ¼ã‚¹

åŒæ™‚å®Ÿè¡Œæ€§ç«¶åˆã¯ã€ä¸»ã«ã€Œèª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ãŒæ··ã–ã£ãŸæ“ä½œï¼ˆRead-Modify-Writeï¼‰ã€ã§ç™ºç”Ÿã—ã¾ã™ã€‚

- **å˜ç´”ãªèª­ã¿å–ã‚Šï¼ˆread-onlyï¼‰**ï¼šå®‰å…¨ã€ç«¶åˆãªã—
- **èª­ã¿å–ã‚Š + è¨ˆç®— + æ›¸ãè¾¼ã¿ï¼ˆread-modify-writeï¼‰**ï¼šå±é™ºã€ç«¶åˆã®å¯èƒ½æ€§ã‚ã‚Š

### å®Ÿéš›ã®ä¾‹

- éŠ€è¡Œå£åº§ã®æŒ¯è¾¼
- ãƒã‚¤ãƒ³ãƒˆã®ãƒãƒ£ãƒ¼ã‚¸/åˆ©ç”¨
- åœ¨åº«æ•°ã®æ¸›ç®—
- çµ±è¨ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å¢—åŠ 

---

## 3ï¸âƒ£ Javaã§ç«¶åˆãŒç™ºç”Ÿã™ã‚‹ç†ç”±

- JVMã®ãƒ¡ãƒ¢ãƒªãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚Šã€ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«CPUã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸Šã«å€¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆãŒã‚ã‚‹
- HashMapãªã©ã®é€šå¸¸ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¿è­·ã—ãªã„

ãã®ãŸã‚ã€èª­ã¿æ›¸ãä¸­ã«ä»–ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒæ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€å€¤ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

---

## 4ï¸âƒ£ ç«¶åˆã‚’é˜²ãæ–¹æ³•

### â‘  synchronized

```java
synchronized(userIdLock) {
    long current = userPointTable.selectById(userId).point();
    long updated = current + amount;
    userPointTable.insertOrUpdate(userId, updated);
}

## 2ï¸âƒ£ Synchronized / per-user Lockã«ã‚ˆã‚‹è§£æ±º

å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ã¦é †åºåˆ¶å¾¡ã™ã‚‹ã“ã¨ã§è¡çªã‚’å›é¿ã§ãã¾ã™ã€‚

### ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã®å‡¦ç†

| ã‚¹ãƒ¬ãƒƒãƒ‰ | å‹•ä½œ |
|----------|------|
| Thread A | lockå–å¾— â†’ read â†’ calculate â†’ write â†’ lockè§£æ”¾ |
| Thread B | lockå¾…æ©Ÿ â†’ Thread Aå®Œäº†å¾Œ lockå–å¾— â†’ read â†’ calculate â†’ write â†’ lockè§£æ”¾ |
```

### â‘¡ ReentrantLock

```java
lock.lock();
try {
    long current = userPointTable.selectById(userId).point();
    long updated = current + amount;
    userPointTable.insertOrUpdate(userId, updated);
} finally {
    lock.unlock();
}

- å„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒ­ãƒƒã‚¯ã‚’ç®¡ç†
- è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åŒæ™‚ã«ãƒãƒ£ãƒ¼ã‚¸å¯èƒ½
- åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é †åºé€šã‚Šã«å‡¦ç†ã•ã‚Œã‚‹

User1 Lock Map:
{ userId=1 -> LOCK }

Thread A: lock(userId=1) -> read -> update -> write -> unlock
Thread B: lock(userId=1) -> read -> update -> write -> unlock (å¾…æ©Ÿ)
Thread C: lock(userId=2) -> read -> update -> write -> unlock (åŒæ™‚å‡¦ç†å¯èƒ½)
```

### â‘¢ Atomicæ¼”ç®— / CAS

- AtomicLongãªã©ã®åŸå­å‹ã‚’åˆ©ç”¨
- ä¸Šæ›¸ãã§ã¯ãªã **Compare-And-Swapï¼ˆCASï¼‰** ã«ã‚ˆã‚Šå€¤ã‚’æ›´æ–°

### â‘£ ConcurrentHashMap

- è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ãŒç•°ãªã‚‹ã‚­ãƒ¼ã«åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ç‰¹å®šã‚­ãƒ¼ã«å¯¾ã—ã¦ã®ã¿ lock ã‚„ atomic å‡¦ç†ãŒå¯èƒ½

---

## çµæœ

```java
pool-2-thread-50 å®Ÿè¡Œé–‹å§‹
pool-2-thread-50 å®Ÿè¡Œçµ‚äº†: 100
pool-2-thread-41 å®Ÿè¡Œé–‹å§‹
pool-2-thread-41 å®Ÿè¡Œçµ‚äº†: 200
pool-2-thread-42 å®Ÿè¡Œé–‹å§‹
pool-2-thread-42 å®Ÿè¡Œçµ‚äº†: 300
pool-2-thread-46 å®Ÿè¡Œé–‹å§‹
pool-2-thread-46 å®Ÿè¡Œçµ‚äº†: 400
pool-2-thread-45 å®Ÿè¡Œé–‹å§‹
pool-2-thread-45 å®Ÿè¡Œçµ‚äº†: 500
pool-2-thread-44 å®Ÿè¡Œé–‹å§‹
pool-2-thread-44 å®Ÿè¡Œçµ‚äº†: 600
pool-2-thread-43 å®Ÿè¡Œé–‹å§‹
pool-2-thread-43 å®Ÿè¡Œçµ‚äº†: 700
pool-2-thread-48 å®Ÿè¡Œé–‹å§‹
pool-2-thread-48 å®Ÿè¡Œçµ‚äº†: 800
pool-2-thread-49 å®Ÿè¡Œé–‹å§‹
pool-2-thread-49 å®Ÿè¡Œçµ‚äº†: 900
pool-2-thread-47 å®Ÿè¡Œé–‹å§‹
pool-2-thread-47 å®Ÿè¡Œçµ‚äº†: 1000
pool-2-thread-17 å®Ÿè¡Œé–‹å§‹
pool-2-thread-17 å®Ÿè¡Œçµ‚äº†: 1100
pool-2-thread-19 å®Ÿè¡Œé–‹å§‹
pool-2-thread-19 å®Ÿè¡Œçµ‚äº†: 1200
pool-2-thread-24 å®Ÿè¡Œé–‹å§‹
pool-2-thread-24 å®Ÿè¡Œçµ‚äº†: 1300
pool-2-thread-25 å®Ÿè¡Œé–‹å§‹
pool-2-thread-25 å®Ÿè¡Œçµ‚äº†: 1400
pool-2-thread-27 å®Ÿè¡Œé–‹å§‹
pool-2-thread-27 å®Ÿè¡Œçµ‚äº†: 1500
pool-2-thread-38 å®Ÿè¡Œé–‹å§‹
pool-2-thread-38 å®Ÿè¡Œçµ‚äº†: 1600
pool-2-thread-29 å®Ÿè¡Œé–‹å§‹
pool-2-thread-29 å®Ÿè¡Œçµ‚äº†: 1700
pool-2-thread-30 å®Ÿè¡Œé–‹å§‹
pool-2-thread-30 å®Ÿè¡Œçµ‚äº†: 1800
pool-2-thread-32 å®Ÿè¡Œé–‹å§‹
pool-2-thread-32 å®Ÿè¡Œçµ‚äº†: 1900
pool-2-thread-31 å®Ÿè¡Œé–‹å§‹
pool-2-thread-31 å®Ÿè¡Œçµ‚äº†: 2000
pool-2-thread-33 å®Ÿè¡Œé–‹å§‹
pool-2-thread-33 å®Ÿè¡Œçµ‚äº†: 2100
pool-2-thread-34 å®Ÿè¡Œé–‹å§‹
pool-2-thread-34 å®Ÿè¡Œçµ‚äº†: 2200
pool-2-thread-35 å®Ÿè¡Œé–‹å§‹
pool-2-thread-35 å®Ÿè¡Œçµ‚äº†: 2300
pool-2-thread-37 å®Ÿè¡Œé–‹å§‹
pool-2-thread-37 å®Ÿè¡Œçµ‚äº†: 2400
pool-2-thread-28 å®Ÿè¡Œé–‹å§‹
pool-2-thread-28 å®Ÿè¡Œçµ‚äº†: 2500
pool-2-thread-39 å®Ÿè¡Œé–‹å§‹
pool-2-thread-39 å®Ÿè¡Œçµ‚äº†: 2600
pool-2-thread-40 å®Ÿè¡Œé–‹å§‹
pool-2-thread-40 å®Ÿè¡Œçµ‚äº†: 2700
pool-2-thread-8 å®Ÿè¡Œé–‹å§‹
pool-2-thread-8 å®Ÿè¡Œçµ‚äº†: 2800
pool-2-thread-4 å®Ÿè¡Œé–‹å§‹
pool-2-thread-4 å®Ÿè¡Œçµ‚äº†: 2900
pool-2-thread-6 å®Ÿè¡Œé–‹å§‹
pool-2-thread-6 å®Ÿè¡Œçµ‚äº†: 3000
pool-2-thread-9 å®Ÿè¡Œé–‹å§‹
pool-2-thread-9 å®Ÿè¡Œçµ‚äº†: 3100
pool-2-thread-36 å®Ÿè¡Œé–‹å§‹
pool-2-thread-36 å®Ÿè¡Œçµ‚äº†: 3200
pool-2-thread-10 å®Ÿè¡Œé–‹å§‹
pool-2-thread-10 å®Ÿè¡Œçµ‚äº†: 3300
pool-2-thread-11 å®Ÿè¡Œé–‹å§‹
pool-2-thread-11 å®Ÿè¡Œçµ‚äº†: 3400
pool-2-thread-12 å®Ÿè¡Œé–‹å§‹
pool-2-thread-12 å®Ÿè¡Œçµ‚äº†: 3500
pool-2-thread-22 å®Ÿè¡Œé–‹å§‹
pool-2-thread-22 å®Ÿè¡Œçµ‚äº†: 3600
pool-2-thread-21 å®Ÿè¡Œé–‹å§‹
pool-2-thread-21 å®Ÿè¡Œçµ‚äº†: 3700
pool-2-thread-26 å®Ÿè¡Œé–‹å§‹
pool-2-thread-26 å®Ÿè¡Œçµ‚äº†: 3800
pool-2-thread-16 å®Ÿè¡Œé–‹å§‹
pool-2-thread-16 å®Ÿè¡Œçµ‚äº†: 3900
pool-2-thread-14 å®Ÿè¡Œé–‹å§‹
pool-2-thread-14 å®Ÿè¡Œçµ‚äº†: 4000
pool-2-thread-13 å®Ÿè¡Œé–‹å§‹
pool-2-thread-13 å®Ÿè¡Œçµ‚äº†: 4100
pool-2-thread-18 å®Ÿè¡Œé–‹å§‹
pool-2-thread-18 å®Ÿè¡Œçµ‚äº†: 4200
pool-2-thread-20 å®Ÿè¡Œé–‹å§‹
pool-2-thread-20 å®Ÿè¡Œçµ‚äº†: 4300
pool-2-thread-23 å®Ÿè¡Œé–‹å§‹
pool-2-thread-23 å®Ÿè¡Œçµ‚äº†: 4400
pool-2-thread-2 å®Ÿè¡Œé–‹å§‹
pool-2-thread-2 å®Ÿè¡Œçµ‚äº†: 4500
pool-2-thread-15 å®Ÿè¡Œé–‹å§‹
pool-2-thread-15 å®Ÿè¡Œçµ‚äº†: 4600
pool-2-thread-5 å®Ÿè¡Œé–‹å§‹
pool-2-thread-5 å®Ÿè¡Œçµ‚äº†: 4700
pool-2-thread-3 å®Ÿè¡Œé–‹å§‹
pool-2-thread-3 å®Ÿè¡Œçµ‚äº†: 4800
pool-2-thread-1 å®Ÿè¡Œé–‹å§‹
pool-2-thread-1 å®Ÿè¡Œçµ‚äº†: 4900
pool-2-thread-7 å®Ÿè¡Œé–‹å§‹
pool-2-thread-7 å®Ÿè¡Œçµ‚äº†: 5000

æœ€çµ‚ãƒã‚¤ãƒ³ãƒˆ: 5000
```

## ğŸ’¡ ã¾ã¨ã‚

Javaã«ãŠã‘ã‚‹åŒæ™‚å®Ÿè¡Œæ€§ç«¶åˆã¯ã€**èª­ã¿å–ã‚Š â†’ è¨ˆç®— â†’ æ›¸ãè¾¼ã¿ï¼ˆRead-Modify-Writeï¼‰** ã®æ“ä½œã‚’è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒæ™‚ã«è¡Œã†ã“ã¨ã§ç™ºç”Ÿã—ã¾ã™ã€‚

å¯¾ç­–ã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒ­ãƒƒã‚¯ã€`synchronized`ã€`ReentrantLock`ã€Atomicæ“ä½œãªã©ã‚’æ´»ç”¨ã—ã¦ã€ç«¶åˆã‚’é˜²æ­¢ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
